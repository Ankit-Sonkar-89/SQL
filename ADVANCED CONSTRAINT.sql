CREATE DATABASE CONSTRAINT_PRACTICE ;
USE CONSTRAINT_PRACTICE ;

# TABLE ALL CONSTRAINTS COVERED
CREATE TABLE DEPARTMENT (
DEPT_ID INT PRIMARY KEY ,
DEPT_NAME VARCHAR(50) NOT NULL UNIQUE
);

# EMPLOYEE ( PK + FK + CHECK + DEFAULT + ON DELETE/UPDATE RULES 
CREATE TABLE EMPLOYEE (
EMP_ID INT PRIMARY KEY ,
EMP_NAME VARCHAR(50) NOT NULL ,
EMAIL VARCHAR(80) UNIQUE ,
SALARY INT NOT NULL CHECK ( SALARY >=10000 ) ,
GENDER CHAR(1) CHECK ( GENDER IN ('M' , 'F' )),
JOIN_DATE DATE DEFAULT (CURRENT_DATE),
DEPT_ID INT NULL ,
CONSTRAINT FK_EMP_DEPT FOREIGN KEY ( DEPT_ID )
REFERENCES DEPARTMENT(DEPT_ID)
ON DELETE SET NULL
ON UPDATE CASCADE
);

# PROJECT ( PK + CHECK + DEFAULT )
CREATE TABLE PROJECT (
PROJECT_ID INT PRIMARY KEY ,
PROJECT_NAME VARCHAR(60) NOT NULL UNIQUE ,
BUDGET INT CHECK ( BUDGET>0),
STATUS VARCHAR(20) DEFAULT 'ACTIVE'
);

# EMPLOYEE_PROJECT ( COMPOSITE PK + FK + CASCADE )
CREATE TABLE EMPLOYEE_PROJECT (
EMP_ID INT ,
PROJECT_ID INT ,
ASSIGNED_DATE DATE DEFAULT ( CURRENT_DATE),
PRIMARY KEY ( EMP_ID , PROJECT_ID ),
CONSTRAINT FK_EP_EMP FOREIGN KEY ( EMP_ID )
REFERENCES EMPLOYEE(EMP_ID)
ON DELETE CASCADE 
ON UPDATE CASCADE ,

CONSTRAINT FK_EP_PROJ FOREIGN KEY ( PROJECT_ID )
REFERENCES PROJECT(PROJECT_ID)
ON DELETE CASCADE 
ON UPDATE CASCADE
);

# INSERT DATA
# INSERT INTO DEPARTMENT

INSERT INTO DEPARTMENT VALUES 
(10,"IT" ),
(20,"HR"),
(30,"FINANACE");

#INSERT INTO EMPLOYEE 
INSERT INTO EMPLOYEE(EMP_ID , EMP_NAME , EMAIL , SALARY , GENDER , DEPT_ID ) VALUES 
(1,"ANKIT","ANKIT@GMAIL.COM",25000,"M",10),
(2,"AFTAB","AFTAB@GMAIL.COM",30000,"M",10),
(3,"AMAN","AMAN@GMAIL.COM",20000,"M",20),
(4,"NEHA","NEHA@GMAIL.COM",18000,"M",30);

# INSERT INTO PROJECT
INSERT INTO PROJECT ( PROJECT_ID , PROJECT_NAME , BUDGET , STATUS ) VALUES 
(101,"PAYROLL SYSTEM",500000,"ACTIVE"),
(102,"LIBRARY APP " , 200000,"ACTIVE"),
(103,"STOCK ANALYSIS ",300000,"ACTIVE");

INSERT INTO EMPLOYEE_PROJECT ( EMP_ID , PROJECT_ID ) VALUES 
(1,101),
(1,102),
(2,101),
(3,103),
(4,102);

# TESTING CONSTRAINTS ( TRY THESE )
#CHECK CONSTRAINT TEST
#SALARY LESS THAN 10000 SHOULD FAIL

INSERT INTO EMPLOYEE(EMP_ID , EMP_NAME , EMAIL , SALARY , GENDER , DEPT_ID ) VALUES
(5,"ROHIT","ROHIT@GMAIL.COM",5000,"M",10);
#GENDER M/F(PASS)
INSERT INTO EMPLOYEE(EMP_ID , EMP_NAME , EMAIL , SALARY , GENDER , DEPT_ID )VALUES 
(6,"SIMRAN","SIMRAN@GMAIL.COM",15000,"M",10);
#GENDER NOT M/F(SHOULD FAIL)
INSERT INTO EMPLOYEE(EMP_ID , EMP_NAME , EMAIL , SALARY , GENDER , DEPT_ID )VALUES 
(7,"SIMRAN","SIMRAN@GMAIL.COM",15000,"X",20);

# UNIQUE CONSTRAINT TEST 
# DUPLICATE EMAIL SHOULD FAIL
INSERT INTO EMPLOYEE(EMP_ID , EMP_NAME , EMAIL , SALARY , GENDER , DEPT_ID )VALUES 
(8,"SIMRAN","ANKIT@GMAIL.COM",15000,"M",20);

# DEFAULT CONSTRAINT TEST 
# JOIN_DATE SHOULD AUTO INSERT CURRENT DATE 
INSERT INTO EMPLOYEE( EMP_ID , EMP_NAME , EMAIL , SALARY , GENDER , DEPT_ID )
VALUES(9,"KARAN","KARAN@GMAIL.COM",15000,"M",30);

SELECT EMP_ID , EMP_NAME , JOIN_DATE FROM EMPLOYEE WHERE EMP_ID = 9;
# FOREIGN KEY TEST
#DEPT_ID NOT EXISTING SHOULD FAIL 
INSERT INTO EMPLOYEE( EMP_ID , EMP_NAME , EMAIL , SALARY , GENDER , DEPT_ID )
VALUES(10,"RIYA","RIYA@GMAIL.COM",16000,"F",99);

# ADVANCED CONSTRAINT PRACTICE ( ON DELETE 
# ON DELETE SET NULL TEST 
# DELETE A DEPARTMENT AND SEE EFFECT ON EMPLOYEES :

DELETE FROM DEPARTMENT WHERE DEPT_ID = 10;
SELECT EMP_ID , EMP_NAME , DEPT_ID FROM EMPLOYEE;
# EMPLOYEE WHO WERE IN DEPT_ID = 10 WILL NOW HAVE DEPT_ID = NULL 

# ON  UPDATE CASCADE TEST
# UPDATE DEPARTMENT ID AND SEE EFFECT:
UPDATE DEPARTMENT SET DEPT_ID = 55 WHERE DEPT_ID = 20;
SELECT EMP_ID , EMP_NAME , DEPT_ID FROM EMPLOYEE ;
# DEPT_ID 20 BECOMES 55 AUTOMATICALLY .

# ON DELETE CASCADE TEST ( EMPLOYEE_PROJECT )
DELETE FROM EMPLOYEE WHERE EMP_ID = 1;
 SELECT * FROM EMPLOYEE_PROJECT ;
 # EMP_ID = 1 RELATED ROWS DELETED AUTOMATICALLY .
 
 # PRACTICE QUERY SET ( CONSTRAINT BASED )
 # LEVEL 1
 # SHOWS ALL EMPLOYEES
 SELECT * FROM EMPLOYEE ;
 #SHOWS EMPLOYEES WHOSE DEPT_ID IS NULL
 SELECT * FROM EMPLOYEE WHERE DEPT_ID IS NULL ;
 #SHOWS EMPLOYEE SALARY >=20000
 SELECT EMP_NAME , SALARY FROM EMPLOYEE WHERE SALARY >=20000;
 # SHOW ALL PROJECTS WITH STATUS ACTIVE.
 SELECT * FROM PROJECT WHERE STATUS = "ACTIVE";
 
 # LEVEL 2 JOINS
 # SHOW EMPLOYEE NAME + DEPARTMENT NAME 
 SELECT E.EMP_NAME , D.DEPT_NAME
 FROM EMPLOYEE E
 LEFT JOIN DEPARTMENT D ON E.DEPT_ID = D.DEPT_ID;
 
 #SHOWS EMPLOYEES WORKING IN IT DEPARTMENT
 SELECT E.EMP_NAME
 FROM EMPLOYEE E
 JOIN DEPARTMENT D ON E.DEPT_ID = D.DEPT_ID
 WHERE D.DEPT_NAME = "IT";

#SHOW EMPLOYEE + PROJECT NAME LIST
SELECT E.EMP_NAME , P.PROJECT_NAME
FROM EMPLOYEE_PROJECT EP
JOIN EMPLOYEE E ON EP.EMP_ID = E.EMP_ID
JOIN PROJECT P ON EP.PROJECT_ID = P.PROJECT_ID ;

# LEVEL 3 ( GROUP BY + HAVING )
# COUNT EMPLOYEES IN EACH DEPARTMENT.
SELECT DEPT_ID , COUNT(*) AS TOTAL_EMP
FROM EMPLOYEE
GROUP BY DEPT_ID ; 
# SHOW DEPARTMENTS HAVING MORE THAN 1 EMPLOYEE
SELECT DEPT_ID, COUNT(*) AS TOTAL_EMP
FROM EMPLOYEE
GROUP BY DEPT_ID
HAVING COUNT(*)>1;
# SHOW PROJECT WISE TOTAL EMPLOYEES
SELECT PROJECT_ID , COUNT(*) AS TOTAL_EMP
FROM EMPLOYEE_PROJECT
GROUP BY PROJECT_ID;

# LEVEL 4 ( CONSTRAINT TESTING QUERIES )
# FIND EMPLOYEES WHO HAVE NO DEPARTMENT AFTER DELETE 
SELECT EMP_ID , EMP_NAME 
FROM EMPLOYEE 
WHERE DEPT_ID IS NULL ;
# FIND EMPLOYEES NOT ASSIGNED TO ANY PROJECT
SELECT E.EMP_ID , E.EMP_NAME 
FROM EMPLOYEE E
LEFT JOIN EMPLOYEE_PROJECT EP ON E.EMP_ID = EP.EMP_ID
WHERE EP.EMP_ID IS NULL;
# SHOW EMPLOYEES ASSIGNED TO MORE THAN 1 PROJECT
SELECT EMP_ID , COUNT(*) AS TOTAL_PROJECTS
FROM EMPLOYEE_PROJECT
GROUP BY EMP_ID 
HAVING COUNT(*)>1;
# UPDATE SALARY +5000 FOR HR DEPARTMENT EMPLOYEES
UPDATE EMPLOYEE
SET SALARY = SALARY + 5000
WHERE DEPT_ID = (SELECT DEPT_ID FROM DEPARTMENT WHERE DEPT_NAME = "HR");
# DELETE PROJECT AND CHECK CASCADE IN MAPPING TABLE
DELETE FROM PROJECT WHERE PROJECT_ID = 102;
SELECT * FROM EMPLOYEE_PROJECT ;

# ALTER TABLE PRACTICE ( ADVANCED )
# ADD NEW CONSTRAINT LATER 
ALTER TABLE PROJECT
ADD CONSTRAINT CHK_STATUS CHECK ( STATUS IN ("ACTIVE","CLOSED","HOLD"));

#ADD DEFAULT LATER 
ALTER TABLE PROJECT
ALTER STATUS SET DEFAULT "ACTIVE";

# INSERT A NEW DEPARTMENT MARKETING WITH
INSERT INTO DEPARTMENT(DEPT_ID , DEPT_NAME )
VALUES (40,"MARKETING");

# INSERT 2 EMPLOYEES IN MARKETING
# SALARY MUST BE >- 10000 
INSERT INTO EMPLOYEE(EMP_ID,EMP_NAME,EMAIL,SALARY,GENDER,DEPT_ID)
VALUES
(10,"ROHIT","ROHIT@GMAIL.COM",15000,"M",40),
(11,"POOJA","POOJA@GMAIL.COM",18000,"F",40);

# TRY INSERTING EMPLOYEE WHERE SALARY SHOULD FAIL
INSERT INTO EMPLOYEE(EMP_ID,EMP_NAME,EMAIL,SALARY,GENDER,DEPT_ID)
VALUES
(12,"AMIT","AMIT@GMAIL.COM",8000,"M",40);
# CONSTRAINT WORKING CURRENTLY 

# UPDATE DEPT_ID OF MARKETING FROM 40->44
# VERIFY ON UPDATE CASCADE
UPDATE DEPARTMENT
SET DEPT_ID = 44
WHERE DEPT_NAME = "MARKETING";

# VERIFY CASCADE EFFECT
SELECT EMP_ID , EMP_NAME , DEPT_ID 
FROM EMPLOYEE
WHERE EMP_ID IN (10,11);

# DELETE MARKETING DEPARTMENT
# VERIFY ON DELETE SET NULL
DELETE FROM DEPARTMENT
WHERE DEPT_ID = 44;

# VERIFY EFFECT ON EMPLOYEES
SELECT EMP_ID , EMP_NAME , DEPT_ID 
FROM EMPLOYEE
WHERE EMP_ID IN (10,11);
